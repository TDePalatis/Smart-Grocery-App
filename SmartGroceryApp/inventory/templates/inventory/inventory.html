{% extends "base.html" %}
{% block title %}Inventory Management{% endblock %}
{% block content %}

<!-- Start Wrapper -->
<div class="page-wrapper">

  <!-- ðŸ“· Header & Description -->
  <section class="section-header">
    <h2>ðŸ§  Smart Grocery Classifier</h2>
    <p>Classify items using image recognition or barcode scanning.</p>
  </section>

  <!-- Start Teachable Machine UI -->
  <div class="classifier-controls">

    <div class="classifier-body">
      <!-- Left: Image Preview -->
      <div class="classifier-preview">
        <img alt="Image preview" id="preview" />
        <p id="output">Model not loaded yet.</p>
      </div>

      <!-- Right: Controls -->
      <div class="classifier-ui">
        <div class="mode-toggle">
          <label for="mode-upload"><input checked id="mode-upload" name="mode" type="radio" value="upload"/> Upload Image</label>
          <label for="mode-webcam"><input id="mode-webcam" name="mode" type="radio" value="webcam"/> Live Webcam</label>
        </div>

        <!-- Upload mode UI -->
        <div id="upload-section">
          <label for="upload">Select an image:</label>
          <input accept="image/*" id="upload" type="file"/><br/>
          <button onclick="predictFromImage()">Predict</button>
          <button onclick="capturePrediction()">ðŸ“¸ Capture Prediction</button>
        </div>

        <!-- Webcam mode UI -->
        <div id="webcam-section" style="display:none;">
          <div id="webcam-container"></div>
          <p>Live predictions running...</p>
          <button onclick="capturePrediction()">ðŸ“¸ Capture Prediction</button>
        </div>

        <!-- Shared confirmation UI -->
        <div id="confirm-section" style="display:none;">
          <label for="confirm-input">Fix prediction if incorrect:</label>
          <input id="confirm-input" placeholder="Corrected item name" type="text"/>
          <button onclick="confirmAndSave()">âœ” Confirm</button>
        </div>

        <!-- Barcode lookup -->
        <form method="post" action="{{ url_for('inventory.lookup_barcode') }}">
          <input type="text" name="barcode" placeholder="Enter Barcode" required>
          <button type="submit">Lookup</button>
        </form>

        <ul id="capture-log"></ul>
      </div>
    </div>
  </div>
  <!-- End Teachable Machine UI -->

  <!-- Scripts stay exactly the same -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>
  <script>
    // [JS code is unchanged here â€” already good]
    const URL = "/static/model/";
    let model, webcam;
    let modelLoaded = false;
    let isWebcamActive = false;
    async function loadModel() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      modelLoaded = true;
      document.getElementById("output").textContent = "Model loaded!";
    }
    loadModel();
    document.getElementById("upload").addEventListener("change", function(event) {
      const reader = new FileReader();
      reader.onload = function() {
        const img = document.getElementById("preview");
        img.src = reader.result;
        img.onload = function() {
          predictFromImage();
        };
      };
      reader.readAsDataURL(event.target.files[0]);
    });
    async function predictFromImage() {
      if (!modelLoaded) {
        document.getElementById("output").textContent = "Model not loaded yet.";
        return;
      }
      const image = document.getElementById("preview");
      if (!image.src || image.src === "") {
        document.getElementById("output").textContent = "Please select an image first.";
        return;
      }
      if (!image.complete) {
        document.getElementById("output").textContent = "Image is still loading...";
        return;
      }
      const prediction = await model.predict(image);
      const top = prediction.reduce((max, p) => p.probability > max.probability ? p : max);
      document.getElementById("output").textContent = `Prediction: ${top.className} (${(top.probability * 100).toFixed(1)}%)`;
    }
    async function enableWebcam() {
      const flip = true;
      webcam = new tmImage.Webcam(300, 300, flip);
      await webcam.setup();
      await webcam.play();
      const container = document.getElementById("webcam-container");
      container.innerHTML = "";
      container.appendChild(webcam.canvas);
      isWebcamActive = true;
      window.requestAnimationFrame(loop);
    }
    async function loop() {
      if (!isWebcamActive) return;
      webcam.update();
      if (modelLoaded) {
        const prediction = await model.predict(webcam.canvas);
        const top = prediction.reduce((max, p) => p.probability > max.probability ? p : max);
        document.getElementById("output").textContent = `Prediction: ${top.className} (${(top.probability * 100).toFixed(1)}%)`;
      }
      if (isWebcamActive) {
        window.requestAnimationFrame(loop);
      }
    }
    document.getElementById("mode-webcam").addEventListener("change", () => {
      document.getElementById("upload-section").style.display = "none";
      document.getElementById("webcam-section").style.display = "block";
      document.getElementById("preview").src = "";
      enableWebcam();
    });
    document.getElementById("mode-upload").addEventListener("change", () => {
      document.getElementById("webcam-section").style.display = "none";
      document.getElementById("upload-section").style.display = "block";
      if (webcam) webcam.stop();
      isWebcamActive = false;
    });
    function capturePrediction() {
      const current = document.getElementById("output").textContent;
      document.getElementById("confirm-input").value = current.includes("Prediction:") ? current.split(":")[1].trim() : "";
      document.getElementById("confirm-section").style.display = "block";
    }
    function confirmAndSave() {
      const confirmedRaw = document.getElementById("confirm-input").value;
      const confirmedClean = confirmedRaw.split("(")[0].trim();
      const itemNameField = document.querySelector('input[name="name"]');
      if (itemNameField) {
        itemNameField.value = confirmedClean;
      }
      const log = document.getElementById("capture-log");
      const li = document.createElement("li");
      li.textContent = "Saved: " + confirmedClean;
      log.appendChild(li);
      document.getElementById("confirm-section").style.display = "none";
    }
  </script>

  <!-- ðŸ“¦ Inventory Section (unchanged) -->
  <div class="container">
    <h2 class="page-title">Inventory Management</h2>
    <div class="form-container">
      <h3>Add or Edit Item</h3>
      <form method="POST">
        {% if edit_item %}
          <input type="hidden" name="item_id" value="{{ edit_item.id }}">
        {% endif %}
        {% if name %}
          <p>Product Found:</p>
          <input type="text" name="name" value="{{ name }}">
        {% else %}
          <input name="name" placeholder="Item Name" type="text" value="{{ edit_item.name if edit_item else '' }}">
        {% endif %}
        <input name="quantity" placeholder="Quantity" type="number" value="{{ edit_item.quantity if edit_item else '' }}">
        
        <!--Category Selector-->
        <select name="category" id="category" class="form-control" required>
             <option value="" disabled selected>Category</option>
            {% for category in categories %}
              <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
        </select>

        <input name="expiration_date" type="date" value="{{ edit_item.expiration_date if edit_item and edit_item.expiration_date else '' }}">
        <button class="btn-save" type="submit">Save Item</button>
      </form>
    </div>

    <h3>Inventory List</h3>
    <table class="inventory-table">
      <thead>
        <tr>
          <th>Item Name</th>
          <th>Quantity</th>
          <th>Expiration Date</th>
          <th>Days Left</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in inventory %}
          <tr>
            <td>{{ item.name }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.expiration_date }}</td>
            <td>{{ item.days_left }} days left</td>
            <td>
              <form method="POST" style="display: inline;">
                <input name="item_id" type="hidden" value="{{ item.id }}">
                <button class="btn-edit" type="submit">Edit</button>
              </form>
              <form method="POST" style="display: inline;">
                <input name="delete_id" type="hidden" value="{{ item.id }}">
                <button class="btn-delete" type="submit">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div> <!-- end page-wrapper -->

{% endblock %}
